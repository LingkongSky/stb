import{r as e,o as a,e as l,g as r,h as u,k as s,a4 as t,I as o,aL as n,a2 as d,au as i,aw as v,ay as p,b as m,f as c,p as f,aM as _,aN as g,A as b,j as w,v as y,a7 as h,am as k,an as C,ao as U,ap as x,a0 as q,F,x as j,m as z,ax as $}from"./vendor-DLaggKmm.js";import{_ as A,u as I,i as L}from"./index-B0llsXYu.js";import{a as M}from"./formatDate-DJT1dS-E.js";const O={class:"users"},B={class:"header"},R=A({__name:"Users",setup(A){const R=e([]),S=m(),D=I(),N=e(!1),P=e(1),E=e(10),G=e(0),H=e(""),J=e([]),K=e(!1),Q=e(null),T=e({username:"",email:"",password:"",role:""}),V=e(!1),W=e(null),X=e({_id:"",username:"",email:"",role:"",status:"",founder:!1,password:""}),Y={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}]},Z={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],password:[{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}]},ee=async()=>{var e;N.value=!0,R.value=[];try{(async()=>{var e;N.value=!0;try{const{data:e}=await L.post("/api/admin/role-groups");J.value=e}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}finally{N.value=!1}})();const{data:e}=await L.post("/api/admin/users",t.stringify({page:P.value,limit:E.value,username:H.value}));G.value=e.total,R.value.push(...e.users)}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}finally{N.value=!1}},ae=()=>{T.value={username:"",email:"",password:"",role:""},K.value=!0,Q.value&&Q.value.resetFields()},le=async()=>{var e;try{await Q.value.validate(),await L.post("/api/admin/users/create",T.value),o.success("用户创建成功"),K.value=!1,ee()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}},re=async()=>{var e;try{await W.value.validate();const e=X.value._id,a={username:X.value.username,email:X.value.email,role:X.value.role,status:X.value.status};X.value.password&&(a.password=X.value.password),X.value.founder&&(delete a.role,delete a.status),await L.patch(`/api/admin/users/${e}`,a),o.success("用户数据更新成功"),V.value=!1,ee()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}};return a(ee),(e,a)=>{const t=n,m=d,A=b,I=g,ue=h,se=_,te=i,oe=v,ne=U,de=C,ie=x,ve=$,pe=q,me=k,ce=p;return c(),l("div",O,[r("div",B,[u(t,{value:H.value,"onUpdate:value":a[0]||(a[0]=e=>H.value=e),allowClear:"",placeholder:"输入用户名搜索",onSearch:ee},null,8,["value"]),u(m,{type:"primary",onClick:ae},{default:s((()=>a[16]||(a[16]=[f("创建用户")]))),_:1,__:[16]})]),u(te,{spinning:N.value},{default:s((()=>[u(se,{data:R.value,"scrollbar-always-on":"",fit:""},{default:s((()=>[u(I,{label:"头像",fixed:""},{default:s((({row:e})=>{var a,l,r;return[u(A,{src:(null==(r=null==(l=null==(a=w(D))?void 0:a.config)?void 0:l.site)?void 0:r.url)+e.avatar},{default:s((()=>[f(y(e.username[0]),1)])),_:2},1032,["src"])]})),_:1}),u(I,{prop:"username","show-overflow-tooltip":"",label:"用户名"}),u(I,{label:"角色组"},{default:s((({row:e})=>[f(y(J.value.find((a=>a.name===e.role.name)).name),1)])),_:1}),u(I,{"show-overflow-tooltip":"",label:"IP地址"},{default:s((({row:e})=>{var a,l;return[f(y((null==(a=e.ip)?void 0:a.ipv4)||(null==(l=e.ip)?void 0:l.ipv6)),1)]})),_:1}),u(I,{prop:"email","show-overflow-tooltip":"",label:"注册邮箱"}),u(I,{prop:"imageCount",sortable:"",label:"图片数量"},{default:s((({row:e})=>[f(y(e.stats.imageCount),1)])),_:1}),u(I,{prop:"usedCapacity",sortable:"",label:"已用容量"},{default:s((({row:e})=>[f(y(e.stats.usedCapacity)+"MB",1)])),_:1}),u(I,{prop:"remainingCapacity",sortable:"",label:"剩余容量"},{default:s((({row:e})=>[f(y(e.stats.remainingCapacity)+"MB",1)])),_:1}),u(I,{prop:"date",label:"状态"},{default:s((({row:e})=>[u(ue,{color:"active"===e.status?"green":"red"},{default:s((()=>[f(y("active"===e.status?"正常":"封号"),1)])),_:2},1032,["color"])])),_:1}),u(I,{prop:"createdAt","show-overflow-tooltip":"",sortable:"",label:"注册时间"},{default:s((({row:e})=>[f(y(w(M)(e.createdAt)),1)])),_:1}),u(I,{prop:"lastLogin","show-overflow-tooltip":"",sortable:"",label:"最后登录"},{default:s((({row:e})=>[f(y(w(M)(e.lastLogin)),1)])),_:1}),u(I,{label:"操作",fixed:"right"},{default:s((({row:e})=>[u(m,{type:"link",onClick:a=>w(S).push(`/user/${e._id}`)},{default:s((()=>a[17]||(a[17]=[f("查看")]))),_:2,__:[17]},1032,["onClick"]),u(m,{type:"link",onClick:a=>{return l=e,X.value={_id:l._id,username:l.username,email:l.email,role:l.role,status:l.status,founder:l.founder,password:""},V.value=!0,void(W.value&&W.value.resetFields());var l}},{default:s((()=>a[18]||(a[18]=[f("编辑")]))),_:2,__:[18]},1032,["onClick"]),u(m,{type:"link",danger:"",onClick:a=>(async e=>{e.founder?o.error("无法删除创始人账号"):p.confirm({title:"确认删除",content:`确定要删除用户 "${e.username}" 的账号吗？`,async onOk(){var a;try{await L.delete(`/api/admin/users/${e._id}`),o.success("该账号已删除"),ee()}catch({response:l}){o.error(null==(a=null==l?void 0:l.data)?void 0:a.error)}}})})(e),disabled:e.founder},{default:s((()=>a[19]||(a[19]=[f("删除")]))),_:2,__:[19]},1032,["onClick","disabled"])])),_:1})])),_:1},8,["data"])])),_:1},8,["spinning"]),u(oe,{class:"pagination",current:P.value,"onUpdate:current":a[1]||(a[1]=e=>P.value=e),"page-size":E.value,"onUpdate:pageSize":a[2]||(a[2]=e=>E.value=e),total:G.value,"show-size-changer":"",onChange:ee},null,8,["current","page-size","total"]),u(ce,{open:K.value,"onUpdate:open":a[7]||(a[7]=e=>K.value=e),title:"创建用户",onOk:le,onCancel:a[8]||(a[8]=e=>K.value=!1)},{default:s((()=>[u(me,{model:T.value,rules:Y,layout:"vertical",ref_key:"createFormRef",ref:Q},{default:s((()=>[u(de,{label:"用户名",name:"username"},{default:s((()=>[u(ne,{value:T.value.username,"onUpdate:value":a[3]||(a[3]=e=>T.value.username=e),"show-count":"",maxlength:10,placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(de,{label:"邮箱",name:"email"},{default:s((()=>[u(ne,{value:T.value.email,"onUpdate:value":a[4]||(a[4]=e=>T.value.email=e),placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(de,{label:"密码",name:"password"},{default:s((()=>[u(ie,{value:T.value.password,"onUpdate:value":a[5]||(a[5]=e=>T.value.password=e),placeholder:"请输入密码"},null,8,["value"])])),_:1}),u(de,{label:"角色组",name:"role"},{default:s((()=>[u(pe,{value:T.value.role,"onUpdate:value":a[6]||(a[6]=e=>T.value.role=e),placeholder:"请选择角色组"},{default:s((()=>[(c(!0),l(F,null,j(J.value,(e=>(c(),z(ve,{value:e._id,key:e._id},{default:s((()=>[f(y(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"]),u(ce,{open:V.value,"onUpdate:open":a[14]||(a[14]=e=>V.value=e),title:"编辑用户",onOk:re,onCancel:a[15]||(a[15]=e=>V.value=!1)},{default:s((()=>[u(me,{model:X.value,rules:Z,layout:"vertical",ref_key:"editFormRef",ref:W},{default:s((()=>[u(de,{label:"用户名",name:"username"},{default:s((()=>[u(ne,{value:X.value.username,"onUpdate:value":a[9]||(a[9]=e=>X.value.username=e),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(de,{label:"邮箱",name:"email"},{default:s((()=>[u(ne,{value:X.value.email,"onUpdate:value":a[10]||(a[10]=e=>X.value.email=e),type:"email",placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(de,{label:"角色组",name:"role"},{default:s((()=>[u(pe,{value:X.value.role._id,"onUpdate:value":a[11]||(a[11]=e=>X.value.role._id=e),disabled:X.value.founder},{default:s((()=>[(c(!0),l(F,null,j(J.value,(e=>(c(),z(ve,{value:e._id,key:e._id},{default:s((()=>[f(y(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value","disabled"])])),_:1}),u(de,{label:"状态",name:"status"},{default:s((()=>[u(pe,{value:X.value.status,"onUpdate:value":a[12]||(a[12]=e=>X.value.status=e),disabled:X.value.founder},{default:s((()=>[u(ve,{value:"active"},{default:s((()=>a[20]||(a[20]=[f("正常")]))),_:1,__:[20]}),u(ve,{value:"disabled"},{default:s((()=>a[21]||(a[21]=[f("封号")]))),_:1,__:[21]})])),_:1},8,["value","disabled"])])),_:1}),u(de,{label:"新密码",name:"password"},{default:s((()=>[u(ie,{value:X.value.password,"onUpdate:value":a[13]||(a[13]=e=>X.value.password=e),placeholder:"留空则不修改密码"},null,8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"])])}}},[["__scopeId","data-v-ec7ba80a"]]);export{R as default};
