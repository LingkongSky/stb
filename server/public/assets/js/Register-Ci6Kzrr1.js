import{r as e,a8 as a,al as r,o as l,I as s,e as t,f as i,h as d,k as o,am as u,m as n,i as c,an as p,ao as v,j as m,aE as g,a2 as f,p as h,v as _,ap as w,c as b,$ as y,b as C,a4 as I,U as x,aF as q,aG as U,ar as k}from"./vendor-DLaggKmm.js";import{_ as P,u as j,i as R}from"./index-CJP2_w2Y.js";import{C as E}from"./Captcha-Wzxxk1f5.js";const F={class:"register"},S=P({__name:"Register",setup(P){const S=C(),$=j(),G=e(!1),L=e(0),z=a((()=>{var e,a;return null==(a=null==(e=null==$?void 0:$.config)?void 0:e.site)?void 0:a.captcha})),A=r({username:"",email:"",code:"",password:"",confirmPassword:"",inviteCode:"",captcha:!1,captchaId:""}),B=a((()=>{var e,a,r,l;let s=!(A.username&&A.email&&A.password&&A.confirmPassword);return(null==(a=null==(e=null==$?void 0:$.config)?void 0:e.smtp)?void 0:a.enabled)&&(s=s||!A.code),(null==(l=null==(r=null==$?void 0:$.config)?void 0:r.site)?void 0:l.inviteCodeRequired)&&(s=s||!A.inviteCode),z.value&&(s=s||!A.captcha||!A.captchaId),s})),D={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}],code:[{required:!0,message:"请输入验证码",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:async(e,a)=>{if(a!==A.password)throw new Error("两次输入的密码不一致")},trigger:"blur"}],inviteCode:[{required:!0,message:"请输入邀请码",trigger:"blur"}]},H=async()=>{if(A.email)try{await R.post("/api/auth/register/send-code",I.stringify({email:A.email,username:A.username})),s.success("验证码已发送到您的邮箱"),L.value=60;const e=setInterval((()=>{L.value--,L.value<=0&&clearInterval(e)}),1e3)}catch({response:e}){s.error(e.data.error||"发送验证码失败")}else s.error("请先输入邮箱")},J=async()=>{var e,a;try{G.value=!0;const{data:e}=await R.post("/api/auth/register",{username:A.username,password:A.password,email:A.email,code:A.code,ip:$.ip,inviteCode:A.inviteCode,captchaId:A.captchaId});$.token=e.token,$.user=e.user,s.success("注册成功"),S.push("/")}catch({response:r}){"滑动验证已失效,请重新验证"===(null==(e=null==r?void 0:r.data)?void 0:e.error)&&(A.captcha=!1,A.captchaId=null),s.error((null==(a=null==r?void 0:r.data)?void 0:a.error)||"注册失败")}finally{G.value=!1}};return l((()=>{new URLSearchParams(location.search).get("oauth")&&(history.replaceState({},document.title,location.pathname),s.error("请注册后再使用本功能"))})),(e,a)=>{const r=v,l=p,s=f,C=g,I=w,P=b("router-link"),j=u,R=y;return i(),t("div",F,[d(R,{class:"register-card",title:"注册"},{default:o((()=>[d(j,{model:A,onFinish:J},{default:o((()=>{var e,t,u,p,v,g;return[d(l,{name:"username",rules:D.username},{default:o((()=>[d(r,{value:A.username,"onUpdate:value":a[0]||(a[0]=e=>A.username=e),"show-count":"",maxlength:10,placeholder:"请输入用户名"},{prefix:o((()=>[d(m(x))])),_:1},8,["value"])])),_:1},8,["rules"]),d(l,{name:"email",rules:D.email},{default:o((()=>[d(r,{value:A.email,"onUpdate:value":a[1]||(a[1]=e=>A.email=e),type:"email",placeholder:"请输入邮箱"},{prefix:o((()=>[d(m(q))])),_:1},8,["value"])])),_:1},8,["rules"]),(null==(u=null==(t=null==(e=m($))?void 0:e.config)?void 0:t.smtp)?void 0:u.enabled)?(i(),n(l,{key:0,name:"code",rules:D.code},{default:o((()=>[d(C,{compact:""},{default:o((()=>[d(r,{value:A.code,"onUpdate:value":a[2]||(a[2]=e=>A.code=e),placeholder:"请输入验证码",style:{width:"calc(100% - 120px)"}},{prefix:o((()=>[d(m(U))])),_:1},8,["value"]),d(s,{disabled:!A.email||!!L.value,style:{width:"120px"},onClick:H},{default:o((()=>[h(_(L.value?`${L.value}s后重试`:"获取验证码"),1)])),_:1},8,["disabled"])])),_:1})])),_:1},8,["rules"])):c("",!0),d(l,{name:"password",rules:D.password},{default:o((()=>[d(I,{value:A.password,"onUpdate:value":a[3]||(a[3]=e=>A.password=e),placeholder:"请输入密码"},{prefix:o((()=>[d(m(k))])),_:1},8,["value"])])),_:1},8,["rules"]),d(l,{name:"confirmPassword",rules:D.confirmPassword},{default:o((()=>[d(I,{value:A.confirmPassword,"onUpdate:value":a[4]||(a[4]=e=>A.confirmPassword=e),placeholder:"请确认密码"},{prefix:o((()=>[d(m(k))])),_:1},8,["value"])])),_:1},8,["rules"]),(null==(g=null==(v=null==(p=m($))?void 0:p.config)?void 0:v.site)?void 0:g.inviteCodeRequired)?(i(),n(l,{key:1,name:"inviteCode",rules:D.inviteCode},{default:o((()=>[d(r,{value:A.inviteCode,"onUpdate:value":a[5]||(a[5]=e=>A.inviteCode=e),placeholder:"请输入邀请码"},{prefix:o((()=>[d(m(k))])),_:1},8,["value"])])),_:1},8,["rules"])):c("",!0),z.value?(i(),n(l,{key:2,required:"",name:"captcha"},{default:o((()=>[d(E,{value:A.captcha,"onUpdate:value":a[6]||(a[6]=e=>A.captcha=e),captchaId:A.captchaId,"onUpdate:captchaId":a[7]||(a[7]=e=>A.captchaId=e)},null,8,["value","captchaId"])])),_:1})):c("",!0),d(l,null,{default:o((()=>[d(s,{type:"primary","html-type":"submit",loading:G.value,disabled:B.value,block:""},{default:o((()=>a[8]||(a[8]=[h(" 注册 ")]))),_:1,__:[8]},8,["loading","disabled"])])),_:1}),d(l,null,{default:o((()=>[d(P,{to:"/login"},{default:o((()=>a[9]||(a[9]=[h("已有账号？去登录")]))),_:1,__:[9]}),a[11]||(a[11]=h(" 或者 ")),d(P,{to:"/resetpassword"},{default:o((()=>a[10]||(a[10]=[h("找回密码")]))),_:1,__:[10]})])),_:1,__:[11]})]})),_:1},8,["model"])])),_:1})])}}},[["__scopeId","data-v-896cae6e"]]);export{S as default};
