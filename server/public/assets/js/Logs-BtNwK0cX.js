import{r as a,o as e,e as l,g as t,h as o,k as r,F as s,a4 as i,I as u,am as n,au as d,aw as v,$ as p,aY as f,f as c,an as m,aZ as y,j as g,a_ as h,ao as _,a2 as b,p as w,aM as x,aN as Y,v as k,ay as D}from"./vendor-DLaggKmm.js";import{_ as C,i as S}from"./index-CJP2_w2Y.js";import{a as M,f as $}from"./formatDate-DJT1dS-E.js";const I={class:"logs-container"},z={class:"search-bar"},A={class:"stats-card"},L=C({__name:"Logs",setup(C){const L=a(!1),O=a([]),P=a([]),U=a(1),j=a(10),N=a(0),R=a(""),T=a(""),B=a(null),F=a(null),X=a(null),Z=a(null),q=a(null),E=a(null),G=async()=>{var a,e,l;L.value=!0;try{const{data:l}=await S.post("/api/admin/logs",i.stringify({page:U.value,limit:j.value,startDate:null==(a=P.value[0])?void 0:a.format("YYYY-MM-DD"),endDate:null==(e=P.value[1])?void 0:e.format("YYYY-MM-DD"),ip:T.value,username:R.value}));O.value=l.logs,N.value=l.total}catch({response:t}){u.error(null==(l=null==t?void 0:t.data)?void 0:l.error)}finally{L.value=!1}},H=async()=>{var a,e,l;try{const{data:l}=await S.post("/api/admin/logs/stats",i.stringify({startDate:null==(a=P.value[0])?void 0:a.format("YYYY-MM-DD"),endDate:null==(e=P.value[1])?void 0:e.format("YYYY-MM-DD")}));J(l)}catch({response:t}){u.error(null==(l=null==t?void 0:t.data)?void 0:l.error)}},J=a=>{Z.value&&Z.value.dispose(),q.value&&q.value.dispose(),E.value&&E.value.dispose(),Z.value=f(B.value),q.value=f(F.value),E.value=f(X.value),Z.value.setOption({tooltip:{trigger:"item",formatter:a=>`${a.seriesName}: ${a.value}`},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:a.dailyStats.map((a=>`${a._id.year}-${a._id.month}-${a._id.day}`)),axisLabel:{rotate:45}},yAxis:{type:"value",name:"上传数量"},series:[{data:a.dailyStats.map((a=>a.count)),type:"line",smooth:!0,name:"上传数量",itemStyle:{color:"#1890ff"}}]}),q.value.setOption({tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},series:[{type:"pie",radius:"50%",data:a.ipStats.map((a=>({name:a._id||"未知IP",value:a.count}))),emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}),E.value.setOption({tooltip:{trigger:"item",formatter:function(a){return`上传数量: ${a.value}`}},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:a.userStats.map((a=>a.username||"未知用户")),axisLabel:{rotate:45}},yAxis:{type:"value",name:"上传数量"},series:[{data:a.userStats.map((a=>a.count)),type:"bar",name:"上传数量",itemStyle:{color:"#1890ff"},emphasis:{itemStyle:{color:"#40a9ff"}}}]})};e((()=>{G(),H()}));const K=()=>{U.value=1,G(),P.value.length&&H()},Q=()=>{P.value.length&&K(),P.value=[],R.value="",T.value=""},V=async()=>{var a;try{D.confirm({title:"确认清空",content:"确定要清空所有日志吗？此操作不可恢复！",okText:"确定",okType:"danger",cancelText:"取消",onOk:async()=>{await S.delete("/api/admin/logs"),u.success("所有日志已清空"),G()}})}catch({response:e}){u.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}};return(a,e)=>{const i=y,f=m,D=_,C=b,Z=n,q=Y,E=x,H=d,J=v,W=p;return c(),l(s,null,[t("div",I,[t("div",z,[o(Z,{layout:"inline"},{default:r((()=>[o(f,{label:"日期范围",class:"range-picker"},{default:r((()=>[o(i,{value:P.value,"onUpdate:value":e[0]||(e[0]=a=>P.value=a),locale:g(h)},null,8,["value","locale"])])),_:1}),o(f,{label:"用户名"},{default:r((()=>[o(D,{value:R.value,"onUpdate:value":e[1]||(e[1]=a=>R.value=a),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),o(f,{label:"IP地址"},{default:r((()=>[o(D,{value:T.value,"onUpdate:value":e[2]||(e[2]=a=>T.value=a),placeholder:"请输入IP地址"},null,8,["value"])])),_:1}),o(f,{class:"search-button"},{default:r((()=>[o(C,{type:"primary",disabled:!P.value.length&&!R.value&&!T.value,onClick:K},{default:r((()=>e[5]||(e[5]=[w(" 搜索 ")]))),_:1,__:[5]},8,["disabled"]),o(C,{style:{"margin-left":"8px"},disabled:!P.value.length,onClick:Q},{default:r((()=>e[6]||(e[6]=[w("重置")]))),_:1,__:[6]},8,["disabled"]),o(C,{type:"primary",danger:"",style:{"margin-left":"8px"},onClick:V},{default:r((()=>e[7]||(e[7]=[w("清空日志")]))),_:1,__:[7]})])),_:1})])),_:1})]),o(H,{spinning:L.value},{default:r((()=>[o(E,{data:O.value,"scrollbar-always-on":"",fit:""},{default:r((()=>[o(q,{label:"用户名","show-overflow-tooltip":"",fixed:""},{default:r((({row:a})=>{var e;return[w(k((null==(e=null==a?void 0:a.user)?void 0:e.username)||"游客"),1)]})),_:1}),o(q,{prop:"ip","show-overflow-tooltip":"",label:"IP地址"}),o(q,{prop:"createdAt","show-overflow-tooltip":"",sortable:"",label:"上传时间"},{default:r((({row:a})=>[w(k(g(M)(a.createdAt)),1)])),_:1}),o(q,{prop:"originalName","show-overflow-tooltip":"",label:"文件名"}),o(q,{prop:"size",sortable:"",label:"文件大小"},{default:r((({row:a})=>[w(k(g($)(a.size)),1)])),_:1}),o(q,{label:"图片尺寸"},{default:r((({row:a})=>[w(k(a.width)+"x"+k(a.height),1)])),_:1}),o(q,{prop:"format",label:"图片格式"}),o(q,{label:"操作",fixed:"right"},{default:r((({row:a})=>[o(C,{type:"link",danger:"",onClick:e=>(async a=>{var e;try{await S.delete(`/api/admin/logs/${a}`),u.success("删除成功"),G()}catch({response:l}){u.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}})(a._id)},{default:r((()=>e[8]||(e[8]=[w("删除")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1},8,["spinning"]),o(J,{current:U.value,"onUpdate:current":e[3]||(e[3]=a=>U.value=a),"page-size":j.value,"onUpdate:pageSize":e[4]||(e[4]=a=>j.value=a),total:N.value,"show-size-changer":"",onChange:G},null,8,["current","page-size","total"])]),t("div",A,[o(W,{title:"每日上传统计"},{default:r((()=>[t("div",{ref_key:"dailyChartRef",ref:B,style:{height:"300px"}},null,512)])),_:1}),o(W,{title:"IP分布统计"},{default:r((()=>[t("div",{ref_key:"ipChartRef",ref:F,style:{height:"300px"}},null,512)])),_:1}),o(W,{title:"用户上传统计"},{default:r((()=>[t("div",{ref_key:"userChartRef",ref:X,style:{height:"300px"}},null,512)])),_:1})])],64)}}},[["__scopeId","data-v-34679396"]]);export{L as default};
