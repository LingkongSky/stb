import{r as e,a8 as a,o as l,e as t,f as n,m as s,i,h as o,k as u,g as r,j as d,v as c,a9 as v,a2 as p,p as m,F as f,x as y,aa as k,$ as g,ab as h,I as w,ac as _,ad as b,ae as x,af as C,ag as D,ah as U,ai as j,aj as L,ak as z}from"./vendor-DLaggKmm.js";import{_ as M,u as T,i as $}from"./index-B0llsXYu.js";import{f as A}from"./formatDate-DJT1dS-E.js";const F=["innerHTML"],I={class:"ant-upload-hint"},R={class:"ant-upload-drag-icon"},H={class:"ant-upload-hint"},S={key:0,class:"file-list"},B={class:"file-list-header"},K={class:"file-list-actions"},O={class:"file-items"},P={class:"file-preview"},W=["src","alt"],E={class:"file-info"},q={class:"file-name"},G={class:"file-size"},J={class:"file-status"},N={key:1,class:"success-text"},Q={key:2,class:"error-text"},V={class:"file-actions"},X={key:1,class:"result-panel"},Y=["onClick"],Z=M({__name:"Home",setup(M){const Z=T(),ee=e([]),ae=e([]),le=e(!1),te=e({url:[],html:[],bbcode:[],markdown:[]}),ne=e(0),se=e("url"),ie=[{key:"url",tab:"URL"},{key:"html",tab:"HTML"},{key:"bbcode",tab:"BBCode"},{key:"markdown",tab:"Markdown"}],oe=e(!1),ue=()=>{const e=new _(".copyAll",{text:()=>te.value[se.value].join("\n")});e.on("success",(a=>{ae.value=[],ee.value=[],te.value={url:[],html:[],bbcode:[],markdown:[]},ne.value=0,a.clearSelection(),w.success("链接已复制到剪贴板"),e.destroy()})),e.on("error",(()=>{w.error("复制失败, 请手动复制"),e.destroy()}))},re=a((()=>{var e,a;const{allowedFormats:l}=null==(a=null==(e=Z.user)?void 0:e.role)?void 0:a.upload;return(null==l?void 0:l.length)?l.map((e=>`image/${e}`)).join(","):"image/*"})),de=a((()=>{var e,a;const{allowedFormats:l}=null==(a=null==(e=Z.user)?void 0:e.role)?void 0:a.upload;return(null==l?void 0:l.length)?l.join(", ").toUpperCase():"all"})),ce=()=>{const e=null==Z?void 0:Z.announcementData;Z.announcement={_id:e._id,nextTime:Date.now()+24*e.nextTime*60*60*1e3}},ve=e=>e.type.startsWith("image/")?(ee.value.push({uid:Date.now()+Math.random().toString(36).slice(2),name:e.name,size:e.size,file:e,preview:URL.createObjectURL(e),status:"waiting",percent:0,error:""}),!1):(w.error("只能上传图片文件！"),!1),pe=async(e,a)=>{var l,t,n,s;try{const{ip:n,config:s,token:i}=Z,o=new FormData;o.append("image",e),o.append("ip",(null==n?void 0:n.ipv4)?null==n?void 0:n.ipv4:null==n?void 0:n.ipv6);const u=(null==(l=null==s?void 0:s.site)?void 0:l.anonymousUpload)&&!i?"/api/tourist/upload":"/api/upload",{data:r}=await $.post(u,o,{onUploadProgress:e=>{a&&a({percent:Math.round(e.loaded/e.total*100)})}}),{url:d,type:c,filename:v}=r;return ae.value.unshift(r),((e,a)=>{const{url:l,html:t,bbcode:n,markdown:s}=te.value;l.push(a),t.push(`<img src="${a}" alt="${e}" />`),n.push(`[img]${a}[/img]`),s.push(`![${e}](${a})`),ne.value=te.value[se.value].length-1})(v,"local"==c?(null==(t=null==s?void 0:s.site)?void 0:t.url)+d:d),r}catch(i){throw new Error((null==(s=null==(n=null==i?void 0:i.response)?void 0:n.data)?void 0:s.error)||i)}},me=async e=>{const a=(e.clipboardData||window.Clipboard).items,l=[];for(let t=0;t<a.length;t++){const e=a[t];if("file"===e.kind&&e.type.startsWith("image/")){const a=e.getAsFile(),n=URL.createObjectURL(a);l.push({uid:Date.now()+t,name:a.name,size:a.size,file:a,preview:n})}}l.length>0&&ee.value.push(...l)},fe=async()=>{const e=ee.value.filter((e=>"waiting"===e.status));if(0!==e.length){oe.value=!0;for(const a of e)await ge(a);oe.value=!1}},ye=()=>{ee.value=ee.value.filter((e=>"success"===e.status||"error"===e.status))},ke=(e,a)=>{const l=new _(e,{text:()=>a});l.on("success",(e=>{e.clearSelection(),w.success("链接已复制到剪贴板"),l.destroy()})),l.on("error",(e=>{w.error("复制失败, 请手动复制"),l.destroy()}))},ge=async e=>{var a,l,t,n;const s=ee.value.findIndex((a=>a.uid===e.uid));if(-1!==s){ee.value[s].status="uploading",ee.value[s].percent=0;try{const i=await pe(e.file,(a=>{const l=ee.value.findIndex((a=>a.uid===e.uid));l>-1&&(ee.value[l].percent=a.percent)}));ee.value[s].status="success",ee.value[s].url="local"==i.type?(null==(l=null==(a=Z.config)?void 0:a.site)?void 0:l.url)+i.url:i.url,ee.value[s].thumb=(null==(n=null==(t=Z.config)?void 0:t.site)?void 0:n.url)+i.thumb}catch(i){ee.value[s].status="error",ee.value[s].error=i.message||"上传失败"}}};return l((()=>{(()=>{var e,a,l;let t=Date.now(),n=(null==(e=null==Z?void 0:Z.announcement)?void 0:e.nextTime)?null==(a=null==Z?void 0:Z.announcement)?void 0:a.nextTime:Date.now();const s=null==Z?void 0:Z.announcementData;s._id!=(null==(l=null==Z?void 0:Z.announcement)?void 0:l._id)&&(Z.announcements=null,n=Date.now()),le.value="alert"===s.type&&t>=n&&s.isActive})()})),(e,a)=>{const l=h,w=v,_=p,M=x,T=C,$=L,ae=k,ne=g;return n(),t("div",{class:"home-container",onPaste:me},[le.value?(n(),s(l,{key:0,title:d(Z).announcementData.title,type:d(Z).announcementData.effect,"show-icon":"",onClose:ce,class:"announcementAlert"},{default:u((()=>[r("div",{innerHTML:d(Z).announcementData.content},null,8,F)])),_:1},8,["title","type"])):i("",!0),o(ne,{class:"upload-card"},{default:u((()=>{var e,l,v,p,k,g,h,x,C;return[r("p",I," 您单次最多可以上传"+c(null==(v=null==(l=null==(e=d(Z).user)?void 0:e.role)?void 0:l.upload)?void 0:v.concurrentUploads)+"张图片, 最大文件大小："+c(null==(g=null==(k=null==(p=d(Z).user)?void 0:p.role)?void 0:k.upload)?void 0:g.maxSize)+"MB ",1),o(w,{beforeUpload:ve,accept:re.value,multiple:"",maxCount:null==(C=null==(x=null==(h=d(Z).user)?void 0:h.role)?void 0:x.upload)?void 0:C.concurrentUploads,showUploadList:!1},{default:u((()=>[r("p",R,[o(d(b))]),a[1]||(a[1]=r("p",{class:"ant-upload-text"},"点击、拖拽或粘贴图片上传",-1)),r("p",H,"支持格式："+c(de.value),1)])),_:1,__:[1]},8,["accept","maxCount"]),ee.value.length>0?(n(),t("div",S,[r("div",B,[r("span",null,"文件列表 ("+c(ee.value.length)+")",1),r("div",K,[o(_,{type:"primary",onClick:fe,loading:oe.value,disabled:!ee.value.some((e=>"waiting"===e.status))},{default:u((()=>a[2]||(a[2]=[m(" 批量上传 ")]))),_:1,__:[2]},8,["loading","disabled"]),o(_,{onClick:ye,disabled:!ee.value.some((e=>"waiting"===e.status||"uploading"===e.status))},{default:u((()=>a[3]||(a[3]=[m(" 清空列表 ")]))),_:1,__:[3]},8,["disabled"])])]),r("div",O,[(n(!0),t(f,null,y(ee.value,(e=>(n(),t("div",{key:e.uid,class:"file-item"},[r("div",P,[r("img",{src:e.preview,alt:e.name},null,8,W)]),r("div",E,[r("div",q,c(e.name),1),r("div",G,c(d(A)(e.size)),1),r("div",J,["uploading"===e.status?(n(),s(M,{key:0,percent:e.percent,size:"small"},null,8,["percent"])):"success"===e.status?(n(),t("span",N,"上传成功")):"error"===e.status?(n(),t("span",Q,c(e.error),1)):i("",!0)])]),r("div",V,["waiting"===e.status?(n(),s(T,{key:0,title:"上传"},{default:u((()=>[o(_,{type:"text",onClick:a=>ge(e)},{default:u((()=>[o(d(D))])),_:2},1032,["onClick"])])),_:2},1024)):i("",!0),"error"===e.status?(n(),s(T,{key:1,title:"重新上传"},{default:u((()=>[o(_,{type:"text",onClick:a=>ge(e)},{default:u((()=>[o(d(U))])),_:2},1032,["onClick"])])),_:2},1024)):i("",!0),o(T,{title:"删除"},{default:u((()=>[o(_,{type:"text",danger:"",onClick:a=>(e=>{const a=ee.value.findIndex((a=>a.uid===e.uid));a>-1&&ee.value.splice(a,1)})(e),disabled:"uploading"===e.status},{default:u((()=>[o(d(j))])),_:2},1032,["onClick","disabled"])])),_:2},1024)])])))),128))])])):i("",!0),te.value[se.value].length>0?(n(),t("div",X,[o(_,{class:"copyAll",type:"primary",onClick:ue},{default:u((()=>a[4]||(a[4]=[m("一键复制")]))),_:1,__:[4]}),o(ae,{activeKey:se.value,"onUpdate:activeKey":a[0]||(a[0]=e=>se.value=e)},{default:u((()=>[(n(),t(f,null,y(ie,(e=>o($,{key:e.key,tab:e.tab,class:"link-items"},{default:u((()=>[(n(!0),t(f,null,y(te.value[se.value],((e,a)=>(n(),t("div",{key:a,class:"link-item"},[r("div",{class:"link-content",onClick:a=>ke(".link-content",e)},c(e),9,Y),o(T,{title:"复制"},{default:u((()=>[o(_,{type:"link",class:"link",onClick:a=>ke(".link",e)},{icon:u((()=>[o(d(z))])),_:2},1032,["onClick"])])),_:2},1024)])))),128))])),_:2},1032,["tab"]))),64))])),_:1},8,["activeKey"])])):i("",!0)]})),_:1})],32)}}},[["__scopeId","data-v-5ce648fa"]]);export{Z as default};
